<!DOCTYPE html>
<html>
<head>
    <title>Рекламный блок</title>
    <style>
        #ad-frame {
            width: 728px;
            height: 90px;
            margin: 20px auto;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        #counter {
            text-align: center;
            margin: 10px;
            font-family: Arial;
        }
    </style>
</head>
<body>
    <div id="ad-container">
        <iframe id="ad-frame" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    <div id="counter">
        Кликов сегодня: <span id="click-count">0</span>/50
    </div>

    <script>
        // Конфигурация
        const BOT_TOKEN = "ВАШ_ТОКЕН"; // Меняйте ежедневно!
        const CHAT_ID = "ВАШ_CHAT_ID";
        const MAX_CLICKS = 50;

        // Данные пользователя из Telegram Mini Apps
        const tgUser = window.Telegram.WebApp.initDataUnsafe?.user || {};
        const userId = tgUser.id || "anon_" + Math.random().toString(36).substring(2);
        const firstName = tgUser.first_name || "Гость";
        let userIp = null;
        let clicksToday = 0;

        // Проверяем лимит кликов через getUpdates
        async function checkClickLimit() {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
                const data = await response.json();
                
                if (!data.ok) return 0;
                
                // Ищем IP в истории сообщений
                const ipPattern = /"ip":\s*"([^"]+)"/g;
                const today = new Date().toLocaleDateString();
                let total = 0;
                
                data.result.forEach(msg => {
                    if (msg.message && msg.message.text.includes(today)) {
                        const matches = [...msg.message.text.matchAll(ipPattern)];
                        if (matches.some(m => m[1] === userIp)) {
                            total++;
                        }
                    }
                });
                
                return total;
            } catch (e) {
                console.error("Ошибка проверки лимита:", e);
                return 0;
            }
        }

        // Получаем IP пользователя
        async function getUserIp() {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        }

        // Отправка данных в Telegram
        async function sendClickReport() {
            const today = new Date().toLocaleString();
            const message = {
                user_id: userId,
                first_name: firstName,
                ip: userIp,
                timestamp: today,
                total_clicks: clicksToday + 1
            };
            
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: `Новый клик:\n${JSON.stringify(message, null, 2)}`
                })
            });
        }

        // Основная логика
        async function init() {
            userIp = await getUserIp();
            clicksToday = await checkClickLimit();
            
            document.getElementById("click-count").textContent = clicksToday;
            
            if (clicksToday >= MAX_CLICKS) {
                document.getElementById("ad-frame").style.pointerEvents = "none";
                alert("Лимит кликов исчерпан!");
                return;
            }
            
            // Загружаем рекламу
            const adUrls = [
                "https://mggsh.github.io/musems-spb/",
                "https://mggsh.github.io/musems-spb/"
            ];
            const randomAd = adUrls[Math.floor(Math.random() * adUrls.length)];
            document.getElementById("ad-frame").src = randomAd;
            
            // Обработчик клика
            document.getElementById("ad-frame").onclick = async () => {
                clicksToday++;
                document.getElementById("click-count").textContent = clicksToday;
                
                await sendClickReport();
                
                // Обновляем рекламу через 1 сек
                setTimeout(() => {
                    document.getElementById("ad-frame").src = 
                        adUrls[Math.floor(Math.random() * adUrls.length)];
                }, 1000);
            };
        }

        // Запуск при загрузке
        document.addEventListener("DOMContentLoaded", init);
    </script>
    
    <!-- Подключение Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>